name: Release

on:
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Dry run (no publish)'
        type: boolean
        default: false

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write # Required for OIDC trusted publishing
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0 # Full history needed for changelog generation
          token: ${{ secrets.GH_PAT }} # PAT to bypass branch protection

      - name: Setup
        uses: ./.github/actions/setup

      - name: Configure npm registry
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version-file: .nvmrc
          registry-url: 'https://registry.npmjs.org'

      - name: Install npm 11+ for trusted publishing
        run: npm install -g npm@latest

      - name: Verify npm version
        run: |
          npm --version
          echo "Trusted publishing requires npm 11.5.1+"

      - name: Build package
        run: yarn prepare

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Release (dry run)
        if: ${{ inputs.dry-run }}
        run: yarn release --ci --dry-run --no-npm
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}

      - name: Get current version (before release)
        if: ${{ !inputs.dry-run }}
        id: pre-release
        run: |
          echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
          echo "commit=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Release (version bump, changelog, git tag, GitHub release)
        if: ${{ !inputs.dry-run }}
        run: yarn release --ci --no-npm
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}

      - name: Get new version (after release)
        if: ${{ !inputs.dry-run }}
        id: post-release
        run: |
          git pull --rebase
          echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
          echo "tag=v$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Rebuild package with new version
        if: ${{ !inputs.dry-run }}
        run: yarn prepare

      - name: Publish to npm (trusted publishing)
        id: npm-publish
        if: ${{ !inputs.dry-run }}
        run: npm publish --access public
        # Note: With trusted publishing (OIDC), provenance is automatic
        # and no NODE_AUTH_TOKEN is needed

      - name: Rollback on npm publish failure
        if: ${{ failure() && steps.npm-publish.outcome == 'failure' && !inputs.dry-run }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "::error::npm publish failed, rolling back release..."

          NEW_VERSION="${{ steps.post-release.outputs.version }}"
          NEW_TAG="${{ steps.post-release.outputs.tag }}"
          PRE_COMMIT="${{ steps.pre-release.outputs.commit }}"

          echo "Rolling back from version ${NEW_VERSION} to commit ${PRE_COMMIT}"

          # Delete the GitHub release
          echo "Deleting GitHub release ${NEW_TAG}..."
          gh release delete "${NEW_TAG}" --yes || echo "Failed to delete release (may not exist)"

          # Delete the remote tag
          echo "Deleting remote tag ${NEW_TAG}..."
          git push origin --delete "${NEW_TAG}" || echo "Failed to delete remote tag"

          # Delete the local tag
          echo "Deleting local tag ${NEW_TAG}..."
          git tag -d "${NEW_TAG}" || echo "Failed to delete local tag"

          # Force push to reset main to pre-release commit
          echo "Resetting main branch to pre-release commit..."
          git reset --hard "${PRE_COMMIT}"
          git push --force origin main

          echo "::error::Rollback complete. The release has been reverted."
          exit 1
